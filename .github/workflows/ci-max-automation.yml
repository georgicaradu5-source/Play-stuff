name: CI - Tests and Dry-Run Gate (Maximum Automation)

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'config*.yaml'
      - 'requirements.txt'
      - 'pyproject.toml'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'config*.yaml'
      - 'requirements.txt'
      - 'pyproject.toml'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nox
          
      - name: Run type checking
        run: nox -s type
        
  test:
    name: Unit Tests (pytest)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nox
          
      - name: Run tests
        run: nox -s test
        
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            .coverage
            htmlcov/
            test-results.xml
          retention-days: 30

  dry-run-gate:
    name: Dry-Run Gate (Safety Validation)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nox
          
      - name: Create minimal .env for dry-run testing
        run: |
          cat << EOF > .env
          X_AUTH_MODE=oauth2
          X_CLIENT_ID=dummy_client_id_for_testing
          X_CLIENT_SECRET=dummy_client_secret_for_testing
          X_REDIRECT_URI=http://localhost:8080/callback
          OPENAI_API_KEY=dummy_openai_key_for_testing
          AUTOMATION_LEVEL=maximum
          HUMAN_APPROVAL_REQUIRED=false
          ENABLE_TELEMETRY=false
          EOF
          
      - name: Run nox type checking
        run: nox -s type
        
      - name: Run nox tests
        run: nox -s test
        
      - name: Dry-run validation with safe config
        run: |
          echo "üîç Testing safe config (dry-run mode)..."
          echo "This validates the config works without making any API calls"
          python src/main.py --config config.safe.yaml --dry-run --mode both
          
      - name: Configuration schema validation
        run: |
          echo "üîç Validating all configuration files..."
          python -c "
          import yaml
          import sys
          from pathlib import Path
          
          # Find all config files
          configs = ['config.yaml', 'config.max-automation.yaml', 'config.safe.yaml']
          
          for config_file in configs:
              if not Path(config_file).exists():
                  print(f'‚ö†Ô∏è  {config_file} does not exist, skipping...')
                  continue
                  
              try:
                  with open(config_file, 'r') as f:
                      data = yaml.safe_load(f)
                  print(f'‚úÖ {config_file} is valid YAML')
                  
                  # Validate required fields
                  required_fields = ['auth_mode', 'plan', 'topics', 'queries']
                  missing_fields = [field for field in required_fields if field not in data]
                  
                  if missing_fields:
                      print(f'‚ùå Missing required fields in {config_file}: {missing_fields}')
                      sys.exit(1)
                      
                  # Validate auth_mode values
                  if data['auth_mode'] not in ['tweepy', 'oauth2']:
                      print(f'‚ùå Invalid auth_mode in {config_file}: {data[\"auth_mode\"]}')
                      sys.exit(1)
                      
                  # Validate plan values
                  if data['plan'] not in ['free', 'basic', 'pro']:
                      print(f'‚ùå Invalid plan in {config_file}: {data[\"plan\"]}')
                      sys.exit(1)
                      
                  print(f'‚úÖ {config_file} schema validation passed')
                      
              except yaml.YAMLError as e:
                  print(f'‚ùå YAML syntax error in {config_file}: {e}')
                  sys.exit(1)
              except Exception as e:
                  print(f'‚ùå Error validating {config_file}: {e}')
                  sys.exit(1)
          
          print('üéØ All configuration files are valid!')
          "
          
      - name: Safety checks simulation
        run: |
          echo "üîç Running safety checks (simulated)..."
          
          # Test safety commands work
          python src/main.py --safety print-budget --config config.safe.yaml || echo "‚ö†Ô∏è  Budget check needs real config"
          python src/main.py --safety print-limits --config config.safe.yaml || echo "‚ö†Ô∏è  Limits check needs real config"
          
          echo "‚úÖ Safety check commands are callable"
          
      - name: Upload dry-run artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dry-run-validation
          path: |
            logs/
            data/agent_unified.db
          retention-days: 14

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Scan for hardcoded secrets
        run: |
          echo "üîç Scanning for potential secrets in codebase..."
          
          # Patterns that should NOT be in the code
          SECRET_PATTERNS=(
            "sk-[a-zA-Z0-9]"  # OpenAI API keys
            "AAAA[A-Za-z0-9]" # Twitter Bearer tokens
            "xox[a-zA-Z]-"    # Slack tokens
            "ya29\."          # Google OAuth tokens
          )
          
          FOUND_SECRETS=false
          
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r "$pattern" --include="*.py" --include="*.yaml" --include="*.yml" src/ config*.yaml 2>/dev/null; then
              echo "‚ùå Found potential secret matching pattern: $pattern"
              FOUND_SECRETS=true
            fi
          done
          
          if [ "$FOUND_SECRETS" = true ]; then
            echo "‚ùå Security scan failed - secrets found in code"
            exit 1
          fi
          
          echo "‚úÖ No hardcoded secrets detected"
          
      - name: Verify .gitignore protection
        run: |
          echo "üîç Checking .gitignore has proper secret protection..."
          
          # Required entries in .gitignore
          REQUIRED_IGNORES=(
            "\.env$"
            "\.token\.json$"
            "\.env\.local$"
          )
          
          for ignore_pattern in "${REQUIRED_IGNORES[@]}"; do
            if ! grep -q "$ignore_pattern" .gitignore; then
              echo "‚ùå Missing from .gitignore: $ignore_pattern"
              exit 1
            fi
          done
          
          echo "‚úÖ .gitignore properly configured to protect secrets"

  automation-readiness:
    name: Automation Readiness Check
    runs-on: ubuntu-latest
    needs: [type-check, test, dry-run-gate, security-scan]
    if: always()
    
    steps:
      - name: Evaluate all checks
        run: |
          echo "=== AUTOMATION READINESS EVALUATION ==="
          echo ""
          echo "Type check result: ${{ needs.type-check.result }}"
          echo "Unit tests result: ${{ needs.test.result }}"
          echo "Dry-run gate result: ${{ needs.dry-run-gate.result }}"
          echo "Security scan result: ${{ needs.security-scan.result }}"
          echo ""
          
          # Check each requirement
          READY=true
          
          if [[ "${{ needs.type-check.result }}" != "success" ]]; then
            echo "‚ùå Type checking failed - code has type errors"
            READY=false
          fi
          
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "‚ùå Unit tests failed - code has test failures"
            READY=false
          fi
          
          if [[ "${{ needs.dry-run-gate.result }}" != "success" ]]; then
            echo "‚ùå Dry-run validation failed - configuration or runtime errors"
            READY=false
          fi
          
          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "‚ùå Security scan failed - potential secrets or vulnerabilities"
            READY=false
          fi
          
          if [[ "$READY" = "true" ]]; then
            echo ""
            echo "üéØ ‚úÖ ALL CHECKS PASSED - READY FOR AUTO-MERGE!"
            echo ""
            echo "This PR is safe for:"
            echo "  ‚Ä¢ Automatic merging"
            echo "  ‚Ä¢ Staging deployment"
            echo "  ‚Ä¢ Production deployment (with approval)"
            echo ""
          else
            echo ""
            echo "‚ùå AUTOMATION BLOCKED - Issues must be resolved"
            echo ""
            echo "This PR requires manual review and fixes before auto-merge."
            exit 1
          fi
          
      - name: Add automation-ready label
        if: github.event_name == 'pull_request' && needs.type-check.result == 'success' && needs.test.result == 'success' && needs.dry-run-gate.result == 'success' && needs.security-scan.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['auto-merge', 'tests-passed', 'automation-ready']
              });
              console.log('‚úÖ Added automation-ready labels to PR');
            } catch (error) {
              console.log('‚ö†Ô∏è  Could not add labels (may not have permission):', error.message);
            }